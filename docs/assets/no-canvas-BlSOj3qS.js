var f=Object.defineProperty;var E=(r,e,a)=>e in r?f(r,e,{enumerable:!0,configurable:!0,writable:!0,value:a}):r[e]=a;var n=(r,e,a)=>E(r,typeof e!="symbol"?e+"":e,a);import"./modulepreload-polyfill-B5Qt9EMX.js";import{V as T}from"./video-tree-C9LeQqEj.js";class c{constructor(e,a,i=[]){n(this,"id");n(this,"src");n(this,"nodes");n(this,"video");this.id=e,this.src=a,this.nodes=i}static fromJSON(e,a=0){var i;return new c(a,e.src,(i=e.nodes)==null?void 0:i.map((s,t)=>c.fromJSON(s,t)))}async load(e){this.video=document.createElement("video"),e(this.video),this.video.playsInline=!0,this.video.preload="auto",this.video.controls=!1,this.video.muted=!0,this.video.autoplay=!0,this.video.src=this.src,this.video.pause();const a=new Promise(t=>{const d=()=>{this.video.removeEventListener("canplay",d);const o=()=>{this.video.removeEventListener("canplaythrough",o),t(this.video)};this.video.addEventListener("canplaythrough",o)};this.video.addEventListener("canplay",d)}),[i,s=[]]=await Promise.all([a,...this.nodes.map(t=>t.load(e))]);return[i,...s]}getNextVideoTree(){const e=this.nodes.length;if(e)return this.nodes[Math.floor(Math.random()*e)]}play(){this.video.play()}}class w{constructor(e,a,{debug:i=!1,transparent:s=!1}){n(this,"tree");n(this,"hiddenPlayersElem");n(this,"metadata",{fps:void 0});n(this,"debug",!1);n(this,"transparent",!1);n(this,"currentVideoTree");var t;this.tree=e,this.hiddenPlayersElem=a,this.debug=i,this.transparent=s,i&&(this.hiddenPlayersElem.classList.add("debug"),(t=document.getElementById("metadata"))==null||t.classList.add("debug"))}async play(){const e=await this.tree.load(t=>this.addEventsCallbacks(t)),a=document.getElementById("hidden-players");if(e.forEach((t,d)=>{this.metadata[this.getVideoName(t)]={last_events:[]},this.debug&&(t.style.border=`2px solid ${V[d]}`),a==null||a.appendChild(t)}),this.transparent){const t=this.createTransparentVideo();t.style.zIndex="101",this.hiddenPlayersElem.appendChild(t)}let i;const s=()=>{if(!i)i=Date.now(),this.metadata.fps=0;else{const t=(Date.now()-i)/1e3;i=Date.now(),this.metadata.fps=Math.round(1/t)}e.forEach(t=>{const{currentTime:d,duration:o,ended:p,paused:g,seeking:v}=t,y=o-d;this.metadata[this.getVideoName(t)].video={currentTime:d.toFixed(3),duration:o.toFixed(3),ended:p,paused:g,seeking:v,tillEnd:y.toFixed(3)}}),this.updateMetadata(),window.requestAnimationFrame(s)};window.requestAnimationFrame(s),this.playNextVideo()}playNextVideo(){var s;const e=((s=this.currentVideoTree)==null?void 0:s.getNextVideoTree())??this.tree;e.play(),e.video.style.zIndex="11",this.currentVideoTree&&(this.currentVideoTree.video.style.zIndex="10");let a=e.video.currentTime;const i=()=>{const{currentTime:t,duration:d}=e.video,o=d-t;if(e.video.ended){this.metadata[this.getVideoName(e.video)].raf_ended=Date.now(),this.playNextVideo(),setTimeout(()=>{e.video.pause(),e.video.currentTime=0},100);return}else if(o>0&&o<.06&&t===a){this.metadata[this.getVideoName(e.video)].endBefore=Date.now(),this.playNextVideo(),setTimeout(()=>{e.video.pause(),e.video.currentTime=0},100);return}a=t,window.requestAnimationFrame(i)};i(),this.currentVideoTree=e}updateMetadata(){if(!this.debug)return;const e=document.getElementById("metadata");if(e){const a=JSON.stringify(this.metadata,null,2);e.innerHTML!==a&&(e.innerHTML=JSON.stringify(this.metadata,null,2))}}getVideoName(e){return e.currentSrc.replace(/(\.mp4)+$/gm,"").slice(-8)}addEventsCallbacks(e){["audioprocess","canplay","canplaythrough","complete","durationchange","emptied","ended","error","loadeddata","loadedmetadata","loadstart","pause","play","playing","progress","ratechange","seeked","seeking","stalled","suspend","timeupdate","volumechange","waiting"].forEach(a=>{e.addEventListener(a,()=>{var s;const i=(s=this.metadata[this.getVideoName(e)])==null?void 0:s.last_events;i&&(i.push(a),i.length>4&&i.shift(),this.metadata[this.getVideoName(e)].last_event_ts=Date.now(),this.updateMetadata())})})}iOS(){return["iPad Simulator","iPhone Simulator","iPod Simulator","iPad","iPhone","iPod"].includes(navigator.platform)||navigator.userAgent.includes("Mac")&&"ontouchend"in document}createTransparentVideo(){const e=document.createElement("video");return e.src="https://ctretyak.github.io/video-test/ezgif-7-98659ba322-part1.webm",e.muted=!0,e.loop=!0,e.autoplay=!0,e}}const V=["red","green","blue","yellow","purple","orange","pink","brown","cyan","magenta","lime","teal","indigo","violet","light-blue","light-green","amber","deep-orange","deep-purple"];let m=T;const h=new URLSearchParams(window.location.search),u=h.get("tree");u&&(m=JSON.parse(u));const b=h.has("debug"),N=h.has("transparent"),P=c.fromJSON(m),L=new w(P,document.getElementById("hidden-players"),{debug:b,transparent:N}),l=document.getElementById("play");l==null||l.addEventListener("click",async()=>{l.innerHTML="Loading...",l.disabled=!0,await L.play(),l.style.display="none"});
