var p=Object.defineProperty;var m=(o,s,e)=>s in o?p(o,s,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[s]=e;var n=(o,s,e)=>m(o,typeof s!="symbol"?s+"":s,e);import"./modulepreload-polyfill-B5Qt9EMX.js";import{C as v,T as u,S as w,c as h,A as f,e as y}from"./index-CU2cXWwI.js";import{V as T}from"./video-tree-C9LeQqEj.js";class g extends v{constructor(e){super();n(this,"tree");n(this,"currentTree");this.tree=e}async play(){const e=new u({text:"Loading",style:{fill:"#fff"}});this.removeChild(e),this.addChild(e),console.time("loaded"),await this.tree.load(),console.timeEnd("loaded"),this.playNextSprite()}playNextSprite(){var t;const e=((t=this.currentTree)==null?void 0:t.getNextVideoTree())||this.tree;e.sprite.play(),this.addChild(e.sprite),e.sprite.once("end",()=>{this.removeChild(e.sprite),this.playNextSprite()}),this.currentTree=e}}class x extends w{constructor(e){super();n(this,"video");n(this,"canvas",document.createElement("canvas"));n(this,"FPS",60);n(this,"frames",[]);this.video=document.createElement("video"),this.video.autoplay=!1,this.video.preload="none",this.video.src=e,this.video.controls=!0;const t=document.getElementById("hidden-video-container");t&&t.appendChild(this.video)}async load(){return new Promise(e=>{const t=async()=>{this.video.removeEventListener("canplay",t),await this.captureFrames(),e()};this.video.addEventListener("canplay",t),this.video.load()})}async captureFrames(){const{duration:e}=this.video,t=1/this.FPS;this.frames=[];for(let i=0;i<=e;i+=t){const a=await this.captureFrame(i);this.frames.push({time:i-t,texture:a})}}captureFrame(e){return new Promise(t=>{const i=async()=>{this.video.removeEventListener("seeked",i),this.canvas.width=this.video.videoWidth,this.canvas.height=this.video.videoHeight;const a=this.canvas.getContext("2d");a==null||a.drawImage(this.video,0,0,this.canvas.width,this.canvas.height);const r=await f.load(this.canvas.toDataURL());t(r)};this.video.currentTime===e?i():(this.video.currentTime=e,this.video.addEventListener("seeked",i))})}play(){const e=Date.now(),t=()=>{this.resize();const i=(Date.now()-e)/1e3,a=this.frames.find(({time:r})=>r>=i);if(!a){h.shared.remove(t),this.emit("end");return}this.texture=a.texture};h.shared.add(t),t()}resize(){const{videoHeight:e,videoWidth:t}=this.video,{screen:{width:i,height:a}}=window.app;let r=1;(t>i||e>a)&&(r=Math.min(i/t,a/e)),this.scale.set(r)}}class d{constructor(s,e,t=[]){n(this,"id");n(this,"sprite");n(this,"nodes");this.id=s,this.sprite=new x(e),this.nodes=t}static fromJSON(s,e=0){var t;return new d(e,s.src,(t=s.nodes)==null?void 0:t.map((i,a)=>d.fromJSON(i,a)))}async load(){await Promise.all([this.sprite.load(),...this.nodes.map(s=>s.load())])}getNextVideoTree(){const s=this.nodes.length;if(s)return this.nodes[Math.floor(Math.random()*s)]}}let l=T;const S=new URLSearchParams(window.location.search),c=S.get("tree");c&&(l=JSON.parse(c));const E=d.fromJSON(l);(async()=>{const o=new y;window.app=o,await o.init({resizeTo:window}),document.body.appendChild(o.canvas);const s=new g(E);o.stage.addChild(s),s.play()})();
