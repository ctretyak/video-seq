var w=Object.defineProperty;var f=(s,e,t)=>e in s?w(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var n=(s,e,t)=>f(s,typeof e!="symbol"?e+"":e,t);import"./modulepreload-polyfill-B5Qt9EMX.js";import{V as L}from"./video-tree-C_pDbh0c.js";class l{constructor(e,t,i=[]){n(this,"id");n(this,"src");n(this,"nodes");n(this,"video");this.id=e,this.src=t,this.nodes=i}static fromJSON(e,t=0){var i;return new l(t,e.src,(i=e.nodes)==null?void 0:i.map((d,a)=>l.fromJSON(d,a)))}async load(){this.video=document.createElement("video"),this.video.playsInline=!0,this.video.preload="auto",this.video.controls=!0,this.video.muted=!0,this.video.autoplay=!0,this.video.src=this.src;const e=new Promise(d=>{const a=()=>{this.video.removeEventListener("canplay",a);const c=()=>{this.video.removeEventListener("canplaythrough",c),this.video.pause(),this.video.currentTime=0,d(this.video)};this.video.addEventListener("canplaythrough",c)};this.video.addEventListener("canplay",a)}),[t,i=[]]=await Promise.all([e,...this.nodes.map(d=>d.load())]);return[t,...i]}getNextVideoTree(){const e=this.nodes.length;if(e)return this.nodes[Math.floor(Math.random()*e)]}play(){this.video.play()}}class V{constructor(e,t,i,d=!1){n(this,"tree");n(this,"canvas");n(this,"hiddenPlayersElem");n(this,"metadata",{});n(this,"currentVideoTree");var a;this.tree=e,this.canvas=t,this.hiddenPlayersElem=i,d&&(this.hiddenPlayersElem.classList.add("debug"),(a=document.getElementById("metadata"))==null||a.classList.add("debug"))}async play(){const e=await this.tree.load(),t=document.getElementById("hidden-players");e.forEach(i=>{t==null||t.appendChild(i)}),this.playNextVideo()}playNextVideo(){var c;const e=document.getElementById("metadata"),t=((c=this.currentVideoTree)==null?void 0:c.getNextVideoTree())??this.tree;t.play();const i=this.canvas.getContext("2d"),d=()=>{i&&(i.canvas.width=Math.min(screen.width,window.innerWidth),i.canvas.height=Math.min(screen.height,window.innerHeight));const o=t.video,{width:p,height:E}=this.canvas.getBoundingClientRect();let m=100,v=100;if(o.videoWidth&&o.videoHeight){const h=Math.min(p/o.videoWidth,E/o.videoHeight);m=o.videoWidth*h,v=o.videoHeight*h}if(i==null||i.drawImage(t.video,0,0,m,v),e){const h=JSON.stringify(this.metadata,null,2);e.innerHTML!==h&&(e.innerHTML=JSON.stringify(this.metadata,null,2))}t.video.requestVideoFrameCallback(d)};t.video.requestVideoFrameCallback(d);const a=()=>{this.metadata.ended=Date.now(),t.video.removeEventListener("ended",a),this.playNextVideo()};t.video.addEventListener("ended",a),this.currentVideoTree=t}}let y=L;const g=new URLSearchParams(window.location.search),u=g.get("tree");u&&(y=JSON.parse(u));const T=g.has("debug"),N=l.fromJSON(y),P=new V(N,document.getElementById("canvas"),document.getElementById("hidden-players"),T),r=document.getElementById("play");r==null||r.addEventListener("click",async()=>{r.innerHTML="Loading...",r.disabled=!0,await P.play(),r.style.display="none"});
