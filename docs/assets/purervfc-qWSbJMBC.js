var T=Object.defineProperty;var N=(l,e,t)=>e in l?T(l,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):l[e]=t;var s=(l,e,t)=>N(l,typeof e!="symbol"?e+"":e,t);import"./modulepreload-polyfill-B5Qt9EMX.js";import{V as P}from"./video-tree-C_pDbh0c.js";class u{constructor(e,t,a=[]){s(this,"id");s(this,"src");s(this,"nodes");s(this,"video");this.id=e,this.src=t,this.nodes=a}static fromJSON(e,t=0){var a;return new u(t,e.src,(a=e.nodes)==null?void 0:a.map((i,d)=>u.fromJSON(i,d)))}async load(e){this.video=document.createElement("video"),e(this.video),this.video.playsInline=!0,this.video.preload="auto",this.video.controls=!0,this.video.muted=!0,this.video.autoplay=!0,this.video.src=this.src,this.video.pause();const t=new Promise(d=>{const o=()=>{this.video.removeEventListener("canplay",o);const r=()=>{this.video.removeEventListener("canplaythrough",r),d(this.video)};this.video.addEventListener("canplaythrough",r)};this.video.addEventListener("canplay",o)}),[a,i=[]]=await Promise.all([t,...this.nodes.map(d=>d.load(e))]);return[a,...i]}getNextVideoTree(){const e=this.nodes.length;if(e)return this.nodes[Math.floor(Math.random()*e)]}play(){this.video.play()}}class L{constructor(e,t,a,i=!1){s(this,"tree");s(this,"canvas");s(this,"hiddenPlayersElem");s(this,"metadata",{});s(this,"currentVideoTree");var d;this.tree=e,this.canvas=t,this.hiddenPlayersElem=a,i&&(this.hiddenPlayersElem.classList.add("debug"),(d=document.getElementById("metadata"))==null||d.classList.add("debug"))}async play(){const e=await this.tree.load(i=>this.addEventsCallbacks(i)),t=document.getElementById("hidden-players");e.forEach(i=>{this.metadata[this.getVideoName(i)]={last_events:[]},t==null||t.appendChild(i)});const a=()=>{e.forEach(i=>{const{currentTime:d,duration:o,ended:r,paused:c,seeking:m}=i,n=o-d;this.metadata[this.getVideoName(i)].video={currentTime:d.toFixed(3),duration:o.toFixed(3),ended:r,paused:c,seeking:m,tillEnd:n.toFixed(3)}}),this.updateMetadata(),window.requestAnimationFrame(a)};window.requestAnimationFrame(a),this.playNextVideo()}playNextVideo(){var r;const e=((r=this.currentVideoTree)==null?void 0:r.getNextVideoTree())??this.tree;e.play();const t=this.canvas.getContext("2d");let a=-1;const i=(c,m)=>{t&&(t.canvas.width=Math.min(screen.width,window.innerWidth),t.canvas.height=Math.min(screen.height,window.innerHeight));const n=e.video,{width:f,height:V}=this.canvas.getBoundingClientRect();let v=100,g=100;if(n.videoWidth&&n.videoHeight){const p=Math.min(f/n.videoWidth,V/n.videoHeight);v=n.videoWidth*p,g=n.videoHeight*p}t==null||t.drawImage(e.video,0,0,v,g),this.updateMetadata(),a=e.video.requestVideoFrameCallback(i)};a=e.video.requestVideoFrameCallback(i);let d=-1;const o=()=>{const{currentTime:c,duration:m}=e.video,n=m-c;if(e.video.ended){this.metadata[this.getVideoName(e.video)].raf_ended=Date.now(),e.video.cancelVideoFrameCallback(a),this.playNextVideo(),e.video.pause(),e.video.currentTime=0;return}else n>0&&n<.06&&d===c&&(e.video.currentTime=e.video.duration);d=c,window.requestAnimationFrame(o)};window.requestAnimationFrame(o),this.currentVideoTree=e}updateMetadata(){const e=document.getElementById("metadata");if(e){const t=JSON.stringify(this.metadata,null,2);e.innerHTML!==t&&(e.innerHTML=JSON.stringify(this.metadata,null,2))}}getVideoName(e){return e.currentSrc.replace(/(\.mp4)+$/gm,"").slice(-8)}addEventsCallbacks(e){["audioprocess","canplay","canplaythrough","complete","durationchange","emptied","ended","error","loadeddata","loadedmetadata","loadstart","pause","play","playing","progress","ratechange","seeked","seeking","stalled","suspend","timeupdate","volumechange","waiting"].forEach(t=>{e.addEventListener(t,()=>{const a=this.metadata[this.getVideoName(e)].last_events;a.push(t),a.length>4&&a.shift(),this.metadata[this.getVideoName(e)].last_event_ts=Date.now(),this.updateMetadata()})})}iOS(){return["iPad Simulator","iPhone Simulator","iPod Simulator","iPad","iPhone","iPod"].includes(navigator.platform)||navigator.userAgent.includes("Mac")&&"ontouchend"in document}}let w=P;const E=new URLSearchParams(window.location.search),y=E.get("tree");y&&(w=JSON.parse(y));const b=E.has("debug"),M=u.fromJSON(w),S=new L(M,document.getElementById("canvas"),document.getElementById("hidden-players"),b),h=document.getElementById("play");h==null||h.addEventListener("click",async()=>{h.innerHTML="Loading...",h.disabled=!0,await S.play(),h.style.display="none"});
