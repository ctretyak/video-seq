var f=Object.defineProperty;var E=(o,e,t)=>e in o?f(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var s=(o,e,t)=>E(o,typeof e!="symbol"?e+"":e,t);import"./modulepreload-polyfill-B5Qt9EMX.js";import{V as w}from"./video-tree-C_pDbh0c.js";class c{constructor(e,t,a=[]){s(this,"id");s(this,"src");s(this,"nodes");s(this,"video");this.id=e,this.src=t,this.nodes=a}static fromJSON(e,t=0){var a;return new c(t,e.src,(a=e.nodes)==null?void 0:a.map((d,i)=>c.fromJSON(d,i)))}async load(e){this.video=document.createElement("video"),e(this.video),this.video.playsInline=!0,this.video.preload="auto",this.video.controls=!1,this.video.muted=!0,this.video.autoplay=!0,this.video.src=this.src,this.video.pause();const t=new Promise(i=>{const n=()=>{this.video.removeEventListener("canplay",n);const l=()=>{this.video.removeEventListener("canplaythrough",l),i(this.video)};this.video.addEventListener("canplaythrough",l)};this.video.addEventListener("canplay",n)}),[a,d=[]]=await Promise.all([t,...this.nodes.map(i=>i.load(e))]);return[a,...d]}getNextVideoTree(){const e=this.nodes.length;if(e)return this.nodes[Math.floor(Math.random()*e)]}play(){this.video.play()}}class T{constructor(e,t,a=!1){s(this,"tree");s(this,"hiddenPlayersElem");s(this,"metadata",{fps:void 0});s(this,"debug",!1);s(this,"currentVideoTree");var d;this.tree=e,this.hiddenPlayersElem=t,this.debug=a,a&&(this.hiddenPlayersElem.classList.add("debug"),(d=document.getElementById("metadata"))==null||d.classList.add("debug"))}async play(){const e=await this.tree.load(i=>this.addEventsCallbacks(i)),t=document.getElementById("hidden-players");e.forEach(i=>{this.metadata[this.getVideoName(i)]={last_events:[]},t==null||t.appendChild(i)});let a;const d=()=>{if(!a)a=Date.now(),this.metadata.fps=0;else{const i=(Date.now()-a)/1e3;a=Date.now(),this.metadata.fps=Math.round(1/i)}e.forEach(i=>{const{currentTime:n,duration:l,ended:p,paused:g,seeking:v}=i,y=l-n;this.metadata[this.getVideoName(i)].video={currentTime:n.toFixed(3),duration:l.toFixed(3),ended:p,paused:g,seeking:v,tillEnd:y.toFixed(3)}}),this.updateMetadata(),window.requestAnimationFrame(d)};window.requestAnimationFrame(d),this.playNextVideo()}playNextVideo(){var a;const e=((a=this.currentVideoTree)==null?void 0:a.getNextVideoTree())??this.tree;e.play(),e.video.style.zIndex="11",this.currentVideoTree&&(this.currentVideoTree.video.style.zIndex="10");const t=()=>{const{currentTime:d,duration:i}=e.video,n=i-d;if(e.video.ended){this.metadata[this.getVideoName(e.video)].raf_ended=Date.now(),e.video.pause(),this.playNextVideo(),e.video.currentTime=0;return}else this.iOS()&&n>0&&n<.06&&(e.video.currentTime=e.video.duration);window.requestAnimationFrame(t)};window.requestAnimationFrame(t),this.currentVideoTree=e}updateMetadata(){if(!this.debug)return;const e=document.getElementById("metadata");if(e){const t=JSON.stringify(this.metadata,null,2);e.innerHTML!==t&&(e.innerHTML=JSON.stringify(this.metadata,null,2))}}getVideoName(e){return e.currentSrc.replace(/(\.mp4)+$/gm,"").slice(-8)}addEventsCallbacks(e){["audioprocess","canplay","canplaythrough","complete","durationchange","emptied","ended","error","loadeddata","loadedmetadata","loadstart","pause","play","playing","progress","ratechange","seeked","seeking","stalled","suspend","timeupdate","volumechange","waiting"].forEach(t=>{e.addEventListener(t,()=>{var d;const a=(d=this.metadata[this.getVideoName(e)])==null?void 0:d.last_events;a&&(a.push(t),a.length>4&&a.shift(),this.metadata[this.getVideoName(e)].last_event_ts=Date.now(),this.updateMetadata())})})}iOS(){return["iPad Simulator","iPhone Simulator","iPod Simulator","iPad","iPhone","iPod"].includes(navigator.platform)||navigator.userAgent.includes("Mac")&&"ontouchend"in document}}let m=w;const u=new URLSearchParams(window.location.search),h=u.get("tree");h&&(m=JSON.parse(h));const V=u.has("debug"),N=c.fromJSON(m),P=new T(N,document.getElementById("hidden-players"),V),r=document.getElementById("play");r==null||r.addEventListener("click",async()=>{r.innerHTML="Loading...",r.disabled=!0,await P.play(),r.style.display="none"});
